<!DOCTYPE HTML>
<html>
  <head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
    <style>
      .subtitle { color: #555; }
      .annotation-note-title { font-size: 13px; text-anchor: middle; }
      .annotation-note-label { font-size: 12px; text-anchor: middle; }
    </style>
  </head>
  <body onload='init()'>
    <h1 style="text-align: center;">Bangladesh Crime Narrative Vis</h1>
    <div class="slide-header">
      <div class="slide-title" id="slide-title"></div>
      <div class="subtitle" id="slide-subtitle"></div>
    </div>
    <div id="controls">
      <label>
        Year:
        <input type="range" id="year-slider" min="2010" max="2025" step="1" value="2010">
        <span id="year-label">2010</span>
      </label>
    </div>
    <div class="nav">
      <button id="back-btn">Back</button>
      <button id="next-btn">Next</button>
      <span id="progress"></span>
    </div>

    
    <svg width="700" height="700"></svg>
    
    <script>
      async function init() {
        // Load & Clean
        const data = await d3.csv("BD_Crime.csv", function(d) { 
          return { 
            unit: d["Names of Unit"].trim(),
            year: +d["Year"],
            dacoity: +d["Dacoity"],
            robbery: +d["Robbery"],
            murder: +d[" Murder"],
            speedy: +d[" Speedy Trial"],
            riot: +d[" Riot"],
            woman_child: +d[" Woman & Child Repression"],
            kidnapping: +d[" Kidnapping"],
            police_assault: +d[" Police Assault"],
            burglary: +d[" Burglary"],
            theft: +d[" Theft"],
            other: +d[" Other Cases"],
            arms: +d["Arms Act"],
            explosive: +d[" Explosive Act"],
            narcotics: +d[" Narcotics"],
            smuggling: +d["Smuggling"],
            total: +d["Total Cases"]
          };
        });
        
        const svg = d3.select("svg");
        
        const totalByYear = d3.nest()
            .key(function(d) {return d.year})
            .rollup(function(values) {return d3.sum(values, function(d) {return  d.total})})
            .entries(data)
            .map(function(d) {return ({ year: +d.key, total: d.value })})
            .sort(function(a,b){return a.year - b.year});;
    
        const state = {
          sceneIndex: 0,
          year: 2010,
          focusCategory: ""
        };
    
        const width = +svg.attr("width") - 50;
        const height = +svg.attr("height") - 50;
        const margin = { top: 40, right: 20, bottom: 60, left: 70 };
    
        const xScale = d3.scaleLinear().range([margin.left, margin.left + width]);
        const yScale = d3.scaleLinear().range([margin.top + height, margin.top]);

        const xAxisGroup = svg.append("g").attr("transform", "translate(0, 690)");
        const yAxisGroup = svg.append("g").attr("transform", "translate(60, 0)");

        const lineGroup = svg.append("g").attr("class", "line-group");
        const barGroup = svg.append("g").attr("class", "bar-group");


        
        const scenes = [
          {
            name: "National Trend",
            title: "Crime Trends in Bangladesh (2010–2020)",
            subtitle: "Total cases by year",
            showYear: false,
            render: () => {
              // Text
              d3.select("#slide-title").text(scenes[0].title);
              d3.select("#slide-subtitle").text(scenes[0].subtitle)
              
              // Prepare data
              const pre2020 = totalByYear.filter(function(d) {return d.year <= 2020})
              xScale.domain(d3.extent(pre2020, function(d) {return d.year}));
              yScale.domain([0, d3.max(pre2020, function(d) {return d.total}) * 1.05]);

              barGroup.style("display", "none");
              lineGroup.style("display", null).selectAll("*").remove();
              
              xAxisGroup.transition().duration(1000).call(d3.axisBottom(xScale).tickFormat(d3.format("d")));
              yAxisGroup.transition().duration(1000).call(d3.axisLeft(yScale));;
            
              // Line chart
              const line = d3.line()
                .x(function(d) {return xScale(d.year)})
                .y(function(d) {return yScale(d.total)})
                .curve(d3.curveMonotoneX);

              lineGroup.append("path")
                .datum(pre2020)
                .attr("fill", "none")
                .attr("stroke", "#1E90FF")
                .attr("stroke-width", 3)
                .attr("d", line)
                .attr("opacity", 0)
                .transition()
                .duration(1000)
                .attr("opacity", 1);

              d3.select("#annotation").text("");
    
              svg.select(".annotation-group").remove();
              
              const annotationData = [
                {
                  note: {
                    label: "A steady increase in crime is seen nationally over the decade.",
                    title: "Trend",
                    align: "middle",
                    wrap: 200
                  },
                  data: { year: 2015, total: totalByYear.find(function(d) {return d.year === 2015})?.total || 0 },
                  dx: 30,
                  dy: -50,
                  color: "#003366",  // dark blue
                  connector: { end: "arrow" }
                }
              ];
              
              const makeAnnotations = d3.annotation()
                .type(d3.annotationLabel)
                .accessors({
                  x: function(d) {return xScale(d.year)},
                  y: function(d) {return yScale(d.total)}
                })
                .annotations(annotationData);
              
              svg.append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations);

            }
          },
          
          {
            name: "National Trend Post Covid",
            title: "Crime Trends in Bangladesh (2010–2025)",
            subtitle: "Total cases by year",
            showYear: false,
            render: () => {
              d3.select("#slide-title").text(scenes[1].title);
              d3.select("#slide-subtitle").text(scenes[1].subtitle);

              barGroup.style("display", "none");
              lineGroup.style("display", null).selectAll("*").remove();
              
              xAxisGroup.transition().duration(1000).call(d3.axisBottom(xScale).tickFormat(d3.format("d")));
              yAxisGroup.transition().duration(1000).call(d3.axisLeft(yScale));;
              
              // Prepare data
              //const post2020 = totalByYear.filter(function(d) {return d.year > 2020})
              xScale.domain(d3.extent(totalByYear, function(d) {return d.year}));
              yScale.domain([0, d3.max(totalByYear, function(d) {return d.total}) * 1.05]);
    
    
              // Line generator
              const line = d3.line()
                .x(function(d) {return xScale(d.year)})
                .y(function(d) {return yScale(d.total)})
                .curve(d3.curveMonotoneX);
    

              lineGroup.append("path")
                .datum(totalByYear)
                .attr("fill", "none")
                .attr("stroke", "#1E90FF")
                .attr("stroke-width", 3)
                .attr("d", line)
                .attr("opacity", 0)
                .transition()
                .duration(1000)
                .attr("opacity", 1);

               svg.select(".annotation-group").remove();
              
              const annotationData = [
                {
                  note: {
                    label: "Crime has consistently been on a decline after the pandemic",
                    title: "Post-2020 Decline",
                    align: "middle",
                    wrap: 220
                  },
                  data: { year: 2022, total: totalByYear.find(function(d) {return d.year === 2022})?.total || 0 },
                  dx: 40,
                  dy: -60,
                  color: "#003366",  // dark blue
                  connector: { end: "arrow" }
                }
              ];
              
              const makeAnnotations = d3.annotation()
                .type(d3.annotationLabel)
                .accessors({
                  x: function(d) {return xScale(d.year)},
                  y: function(d) {return yScale(d.total)}
                })
                .annotations(annotationData);
              
              svg.append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations);
            }
          },
          {
            name: "Category Breakdown",
            title: "Category Breakdown",
            subtitle: "Distribution of cases by type for selected year",
            showYear: true,
            render: () => {
              // Text
              d3.select("#slide-title").text(scenes[2].title);
              d3.select("#slide-subtitle").text(scenes[2].subtitle);
              
              lineGroup.style("display", "none");
              barGroup.style("display", null).selectAll("*").remove();
              
              // Prepare data
              const yearData = data.filter(function(d) { return d.year === state.year});
              const totals = {
                 dacoity: d3.sum(yearData, function(d) {return  d.dacoity}),
                 robbery: d3.sum(yearData, function(d) {return  d.robbery}),
                 murder: d3.sum(yearData, function(d) {return  d.murder}),
                 speedy: d3.sum(yearData, function(d) {return  d.speedy}),
                 riot: d3.sum(yearData, function(d) {return  d.riot}),
                 woman_child: d3.sum(yearData, function(d) {return  d.woman_child}),
                 kidnapping: d3.sum(yearData, function(d) {return  d.kidnapping}),
                 police_assault: d3.sum(yearData, function(d) {return  d.police_assault}),
                 burglary: d3.sum(yearData, function(d) {return  d.burglary}),
                 theft: d3.sum(yearData, function(d) {return  d.theft}),
                 other: d3.sum(yearData, function(d) {return  d.other}),
                 arms: d3.sum(yearData, function(d) {return  d.arms}),
                 explosive: d3.sum(yearData, function(d) {return  d.explosive}),
                 narcotics: d3.sum(yearData, function(d) {return  d.narcotics}),
                 smuggling: d3.sum(yearData, function(d) {return  d.smuggling})
               };

              const categories = Object.entries(totals).map(([key, value]) => ({
                category: key.replace(/_/g, ' ').toUpperCase(),
                value}));


              const x = d3.scaleBand()
                .domain(categories.map(function(d) {return d.category}))
                .range([margin.left, width + margin.left])
                .padding(0.1);
              
              const y = d3.scaleLinear()
                .domain([0, d3.max(categories, function(d) {return d.value}) * 1.1])
                .range([height + margin.top, margin.top]);

              
              xAxisGroup.transition().duration(500).call(d3.axisBottom(x))
              .selectAll("text").attr("transform", "rotate(-45)").style("text-anchor", "end");
              
              yAxisGroup.transition().duration(500).call(d3.axisLeft(y));

              svg.select(".annotation-group").remove();

              const annotationGroup = svg.append("g")
                .attr("class", "annotation-group");
              
              // Update annotation on hover
              function updateAnnotation(categoryData) {
                annotationGroup.selectAll("*").remove();
              
                const annotationData = [
                  {
                    note: {
                      label: `Cases: ${categoryData.value}`,
                      title: categoryData.category,
                      align: "middle",
                      wrap: 200
                    },
                    data: categoryData,
                    dx: 20,
                    dy: -40,
                    color: "#003366",
                    connector: { end: "arrow" }
                  }
                ];
              
                const hoverAnnotation = d3.annotation()
                .type(d3.annotationLabel)
                .accessors({
                  x: function(d) {return x(d.category) + x.bandwidth() / 2},
                  y: function(d) {return y(d.value)}
                })
                .annotations(annotationData);
                
              
                annotationGroup.call(hoverAnnotation);
              }
              
              barGroup.selectAll("rect")
                  .data(categories)
                  .enter()
                  .append("rect")
                  .attr("class", "bar")
                  .attr("x", function(d) {return x(d.category)})
                  .attr("y", function(d) {return y(d.value)})
                  .attr("width", x.bandwidth())
                  .attr("height", function(d) {return y(0) - y(d.value)})
                  .attr("fill", "#1E90FF")
                  .on("mouseover", function(event, d) {
                    updateAnnotation(d); 
                    d3.select(this).attr("fill", "#003366");
                    })
                    .on("mouseout", function(event, d) {
                      annotationGroup.selectAll("*").remove(); 
                      d3.select(this).attr("fill", "#1E90FF");
                    });
            }
          }
        ];
    
    
        // Visualize the current scene
        function renderScene() {
          state.sceneIndex = Math.max(0, Math.min(scenes.length - 1, state.sceneIndex));
          d3.select("#progress").text(`${state.sceneIndex + 1} / ${scenes.length}`);

          
          // Year Slider visibility
          d3.select("#controls").style("display", scenes[state.sceneIndex].showYear ? null : "none");
          if(scenes[state.sceneIndex].showYear){
            d3.select("#year-label").text(state.year);
          }

          // Button Visibility
          d3.select("#back-btn").style("display", state.sceneIndex===0 ? "none" : null);
          d3.select("#next-btn").style("display", state.sceneIndex===scenes.length-1 ? "none" : null);
          
          scenes[state.sceneIndex].render();
        }
    
    
        // Triggers
        d3.select("#next-btn").on("click", () => {
          state.sceneIndex += 1;
          renderScene();
        });
        d3.select("#back-btn").on("click", () => {
          state.sceneIndex -= 1;
          renderScene();
        });
    
        d3.select("#year-slider").on("input", function() {
          state.year = +this.value;
          d3.select("#year-label").text(state.year);
          
          if (scenes[state.sceneIndex].name === "Category Breakdown") {
            renderScene();
          }
        });
        
        renderScene();
        
      }
    </script>
  </body>
</html>


  
